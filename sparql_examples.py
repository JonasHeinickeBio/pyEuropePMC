#!/usr/bin/env python3
"""
SPARQL Query Examples for PyEuropePMC RDF Knowledge Graphs

This script demonstrates various SPARQL queries you can run against the
RDF data generated by test_converters.py. The examples show how to query:

1. Basic publication metadata
2. Author relationships
3. Citation networks
4. Journal information
5. Quality metrics and provenance
6. Cross-references and identifiers

To run these queries, you can use:
- RDF4J Workbench
- Apache Jena Fuseki
- rdflib in Python
- Any SPARQL endpoint

Example Python usage with rdflib:
    from rdflib import Graph
    g = Graph()
    g.parse("test_output/enhanced_semantic.ttl", format="turtle")
    results = g.query(sparql_query)
"""

# ============================================================================
# BASIC PUBLICATION QUERIES
# ============================================================================

BASIC_PUBLICATIONS_QUERY = """
# Get all publications with basic metadata
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX bibo: <http://purl.org/ontology/bibo/>
PREFIX prov: <http://www.w3.org/ns/prov#>

SELECT ?pub ?title ?doi ?pmid ?year ?generatedAt
WHERE {
    ?pub a bibo:AcademicArticle ;
         dcterms:title ?title ;
         bibo:doi ?doi ;
         bibo:pmid ?pmid ;
         dcterms:issued ?year ;
         prov:generatedAtTime ?generatedAt .
}
ORDER BY DESC(?generatedAt)
"""

# ============================================================================
# AUTHOR RELATIONSHIPS
# ============================================================================

AUTHORS_BY_PUBLICATION_QUERY = """
# Get all authors for each publication
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?pub ?authorName ?pubTitle
WHERE {
    ?author a foaf:Person ;
            foaf:name ?authorName ;
            foaf:made ?pub .

    ?pub dcterms:title ?pubTitle .
}
ORDER BY ?pub ?authorName
"""

# ============================================================================
# CITATION NETWORKS
# ============================================================================

CITATION_NETWORK_QUERY = """
# Find citation relationships between publications
PREFIX cito: <http://purl.org/spar/cito/>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?citingPub ?citingTitle ?citedPub ?citedTitle
WHERE {
    ?citingPub cito:cites ?citedPub .

    ?citingPub dcterms:title ?citingTitle .
    ?citedPub dcterms:title ?citedTitle .
}
ORDER BY ?citingPub
"""

CITATION_COUNT_QUERY = """
# Count how many times each publication is cited
PREFIX cito: <http://purl.org/spar/cito/>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?pub ?title (COUNT(?citing) AS ?citationCount)
WHERE {
    ?citing cito:cites ?pub .
    ?pub dcterms:title ?title .
}
GROUP BY ?pub ?title
ORDER BY DESC(?citationCount)
"""

# ============================================================================
# JOURNAL INFORMATION
# ============================================================================

JOURNALS_QUERY = """
# Get journal information and their articles
PREFIX bibo: <http://purl.org/ontology/bibo/>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?journal ?journalTitle ?article ?articleTitle
WHERE {
    ?journal a bibo:Journal ;
             dcterms:title ?journalTitle ;
             bibo:article ?article .

    ?article dcterms:title ?articleTitle .
}
ORDER BY ?journalTitle ?articleTitle
"""

# ============================================================================
# QUALITY METRICS AND PROVENANCE
# ============================================================================

QUALITY_METRICS_QUERY = """
# Get quality scores and confidence levels for publications
PREFIX ex: <https://w3id.org/pyeuropepmc/>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?pub ?title ?qualityScore ?confidenceLevel ?lastUpdated
WHERE {
    GRAPH <https://w3id.org/pyeuropepmc#publications> {
        ?pub ex:qualityScore ?qualityScore ;
             ex:confidenceLevel ?confidenceLevel ;
             ex:lastUpdated ?lastUpdated .
    }

    ?pub dcterms:title ?title .
}
ORDER BY DESC(?qualityScore)
"""

PROVENANCE_QUERY = """
# Get provenance information for all entities
PREFIX prov: <http://www.w3.org/ns/prov#>

SELECT ?entity ?generatedBy ?generatedAt
WHERE {
    ?entity prov:wasGeneratedBy ?generatedBy ;
            prov:generatedAtTime ?generatedAt .
}
ORDER BY DESC(?generatedAt)
"""

# ============================================================================
# CROSS-REFERENCES AND IDENTIFIERS
# ============================================================================

IDENTIFIERS_QUERY = """
# Get all identifiers for each publication
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?pub ?title ?identifier
WHERE {
    ?pub dcterms:title ?title ;
         owl:sameAs ?identifier .
}
ORDER BY ?pub
"""

DOI_TO_PMC_QUERY = """
# Find PMC IDs for publications with DOIs
PREFIX bibo: <http://purl.org/ontology/bibo/>
PREFIX dcterms: <http://purl.org/dc/terms/>

SELECT ?doi ?pmcid ?title
WHERE {
    ?pub bibo:doi ?doi ;
         dcterms:identifier ?pmcid ;
         dcterms:title ?title .

    FILTER(STRSTARTS(?pmcid, "PMC"))
}
ORDER BY ?doi
"""

# ============================================================================
# ADVANCED ANALYTICS
# ============================================================================

PUBLICATIONS_BY_YEAR_QUERY = """
# Count publications by year
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX bibo: <http://purl.org/ontology/bibo/>

SELECT ?year (COUNT(?pub) AS ?count)
WHERE {
    ?pub a bibo:AcademicArticle ;
         dcterms:issued ?year .
}
GROUP BY ?year
ORDER BY DESC(?year)
"""

AUTHOR_COLLABORATION_QUERY = """
# Find authors who have collaborated on multiple papers
PREFIX foaf: <http://xmlns.com/foaf/0.1/>

SELECT ?author1 ?author2 (COUNT(?pub) AS ?collaborationCount)
WHERE {
    ?author1 foaf:made ?pub .
    ?author2 foaf:made ?pub .

    FILTER(?author1 != ?author2)
}
GROUP BY ?author1 ?author2
HAVING (?collaborationCount > 1)
ORDER BY DESC(?collaborationCount)
"""

# ============================================================================
# SEMANTIC SEARCH
# ============================================================================

CANCER_RELATED_PUBLICATIONS_QUERY = """
# Find publications related to cancer (by title keyword)
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX bibo: <http://purl.org/ontology/bibo/>

SELECT ?pub ?title ?doi
WHERE {
    ?pub a bibo:AcademicArticle ;
         dcterms:title ?title ;
         bibo:doi ?doi .

    FILTER(CONTAINS(LCASE(?title), "cancer") ||
           CONTAINS(LCASE(?title), "tumor") ||
           CONTAINS(LCASE(?title), "carcinoma"))
}
ORDER BY ?title
"""

# ============================================================================
# FEDERATED QUERIES (if you have multiple graphs)
# ============================================================================

FEDERATED_QUERY = """
# Query across multiple named graphs
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX ex: <https://w3id.org/pyeuropepmc/>

SELECT ?pub ?title ?qualityScore ?source
FROM <https://w3id.org/pyeuropepmc#publications>
FROM <https://w3id.org/pyeuropepmc#provenance>
WHERE {
    ?pub dcterms:title ?title ;
         ex:qualityScore ?qualityScore ;
         ex:dataSource ?source .
}
ORDER BY DESC(?qualityScore)
"""

# ============================================================================
# PYTHON USAGE EXAMPLES
# ============================================================================


def run_sparql_query(ttl_file, query, format="trig"):
    """
    Example function to run SPARQL queries using rdflib
    """
    from rdflib import Dataset

    g = Dataset()
    g.parse(ttl_file, format=format)

    print(f"Loaded {len(g)} triples from {ttl_file}")

    results = g.query(query)

    print(f"Query returned {len(results)} results:")
    for row in results:
        print(row)
    print()


def demonstrate_queries():
    """
    Demonstrate running queries against the generated RDF files
    """
    import os

    # Check if test_output directory exists
    if not os.path.exists("test_output"):
        print("‚ùå test_output directory not found. Run test_converters.py first.")
        return

    print("üîç Running SPARQL Query Examples")
    print("=" * 50)

    # Example 1: Basic publications
    print("\n1. üìö Basic Publications Query")
    run_sparql_query("test_output/search_only.ttl", BASIC_PUBLICATIONS_QUERY)

    # Example 2: Citation network
    print("\n2. üîó Citation Network Query")
    run_sparql_query("test_output/pipeline_complete.ttl", CITATION_NETWORK_QUERY)

    # Example 3: Quality metrics
    print("\n3. ‚≠ê Quality Metrics Query")
    run_sparql_query("test_output/enhanced_semantic.ttl", QUALITY_METRICS_QUERY)

    # Example 4: Author relationships
    print("\n4. üë• Author Relationships Query")
    run_sparql_query("test_output/pipeline_complete.ttl", AUTHORS_BY_PUBLICATION_QUERY)


if __name__ == "__main__":
    demonstrate_queries()
