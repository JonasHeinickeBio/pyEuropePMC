name: CI â€” Functional Tests

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}
  schedule:
    # Nightly at 03:00 UTC
    - cron: '0 3 * * *'

permissions:
  contents: read
  issues: write

jobs:
  functional:
    name: Functional Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (fetch LFS objects)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Ensure Git LFS objects are present
        run: |
          git lfs install --local || true
          git lfs pull || true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --with dev --no-interaction --no-ansi

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Run functional tests
        id: tests
        run: poetry run pytest -v
        continue-on-error: true

      - name: Create issue on test failure
        if: steps.tests.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current date for issue title
          DATE=$(date +'%Y-%m-%d')

          # Extract test failure summary from pytest output
          FAILURE_SUMMARY=$(poetry run pytest -v --tb=short 2>&1 | tail -20)

          # Create a unique identifier for this failure type
          FAILURE_HASH=$(echo "$FAILURE_SUMMARY" | sha256sum | cut -d' ' -f1 | head -c 16)

          # Check if an issue already exists for this failure
          EXISTING_ISSUE=$(gh issue list --label "functional-test-failure" --state open --json number,title --jq ".[] | select(.title | contains(\"$FAILURE_HASH\")) | .number" | head -1)

          if [ -z "$EXISTING_ISSUE" ]; then
            echo "Creating new issue for functional test failure..."

            # Create the issue body
            ISSUE_BODY="## Functional Test Failure

          **Date:** $DATE
          **Workflow:** ${{ github.workflow }}
          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Test Output
          \`\`\`
          $FAILURE_SUMMARY
          \`\`\`

          ### Details
          - Branch: \`${{ github.ref_name }}\`
          - Commit: \`${{ github.sha }}\`
          - Trigger: \`${{ github.event_name }}\`

          This issue was automatically created when functional tests failed in CI."

            # Create the issue
            gh issue create \
              --title "Functional Test Failure - $DATE ($FAILURE_HASH)" \
              --body "$ISSUE_BODY" \
              --label "functional-test-failure,bug,ci-failure"
          else
            echo "Issue already exists for this failure type: #$EXISTING_ISSUE"
          fi
